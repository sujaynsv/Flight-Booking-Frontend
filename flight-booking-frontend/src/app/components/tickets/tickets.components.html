<div class="tickets-container">
  <h1>My Bookings</h1>
  <p *ngIf="userEmail" class="email-info">Email: {{ userEmail }}</p>

  <!-- Filter Tabs -->
  <div *ngIf="!loading && bookings.length > 0" class="filter-tabs">
    <button 
      type="button"
      class="filter-tab"
      [class.active]="selectedFilter === 'ALL'"
      (click)="setFilter('ALL')">
      All ({{ getTotalCount() }})
    </button>
    <button 
      type="button"
      class="filter-tab"
      [class.active]="selectedFilter === 'CONFIRMED'"
      (click)="setFilter('CONFIRMED')">
      Upcoming ({{ getConfirmedCount() }})
    </button>
    <button 
      type="button"
      class="filter-tab"
      [class.active]="selectedFilter === 'COMPLETED'"
      (click)="setFilter('COMPLETED')">
      Completed ({{ getCompletedCount() }})
    </button>
    <button 
      type="button"
      class="filter-tab"
      [class.active]="selectedFilter === 'CANCELLED'"
      (click)="setFilter('CANCELLED')">
      Cancelled ({{ getCancelledCount() }})
    </button>
  </div>

  <p *ngIf="loading" class="loading-message">Loading...</p>
  <p *ngIf="error" class="error-message">{{ error }}</p>

  <div *ngIf="!loading">
    <p *ngIf="bookings.length === 0" class="no-bookings">No bookings found</p>
    <p *ngIf="filteredBookings.length === 0 && bookings.length > 0" class="no-bookings">
      No {{ selectedFilter.toLowerCase() }} bookings found
    </p>

    <div *ngFor="let booking of filteredBookings" 
         class="booking-card"
         [class.completed]="getEffectiveStatus(booking) === 'COMPLETED'">
      
      <div class="booking-header">
        <h3>PNR: {{ booking.pnr }}</h3>
        <span class="status-badge" 
              [ngClass]="{
                'confirmed': getEffectiveStatus(booking) === 'CONFIRMED',
                'cancelled': getEffectiveStatus(booking) === 'CANCELLED',
                'completed': getEffectiveStatus(booking) === 'COMPLETED'
              }">
          {{ getEffectiveStatus(booking) }}
        </span>
      </div>

      <div class="booking-details">
        <p><strong>Name:</strong> {{ booking.name }}</p>
        <p><strong>Email:</strong> {{ booking.email }}</p>
        <p><strong>Seats:</strong> {{ booking.numberOfSeats }}</p>
        <p><strong>Seat Numbers:</strong> {{ booking.seatNumbers.join(', ') }}</p>
        <p><strong>Journey Date:</strong> {{ booking.journeyDate }}</p>
      </div>

      <div class="passengers-section">
        <strong>Passengers:</strong>
        <div *ngFor="let passenger of booking.passengers; let i = index" class="passenger-item">
          <span class="passenger-name">{{ i + 1 }}. {{ passenger.name }}</span>
          <span class="passenger-info">
            {{ passenger.age }}y, {{ passenger.gender }}, {{ passenger.mealPreference }}
          </span>
        </div>
      </div>

      <!-- Only show cancel button for upcoming confirmed bookings -->
      <button *ngIf="getEffectiveStatus(booking) === 'CONFIRMED' && confirmingPnr !== booking.pnr"
              (click)="askCancelConfirmation(booking.pnr)"
              class="btn-cancel">
        Cancel Booking
      </button>

      <div *ngIf="confirmingPnr === booking.pnr" class="confirmation-dialog">
        <h4>Confirm Cancellation</h4>
        <p>Are you sure you want to cancel booking <strong>{{ booking.pnr }}</strong>?</p>
        
        <button (click)="confirmCancellation(booking.pnr)"
                [disabled]="cancellingPnr === booking.pnr"
                class="btn-confirm-yes">
          {{ cancellingPnr === booking.pnr ? 'Cancelling...' : 'Yes, Cancel' }}
        </button>
        
        <button (click)="closeCancelConfirm()"
                [disabled]="cancellingPnr === booking.pnr"
                class="btn-confirm-no">
          No, Keep Booking
        </button>
      </div>
    </div>

    <div *ngIf="errorFlagFromCancelBooking" class="cancel-error">
      <p>{{ errorMessage }}</p>
      <button (click)="clearCancelError()" class="btn-dismiss">Dismiss</button>
    </div>
  </div>
</div>
