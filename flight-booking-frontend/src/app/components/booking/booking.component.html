<div class="booking-container">
  <div class="booking-card">

    <!-- Success Message -->
    <div *ngIf="flag" class="success-container">
      <h2>{{ successMessage }}</h2>
      <p class="pnr-display">PNR: <strong>{{ pnr }}</strong></p>
      <button type="button" (click)="cancel()" class="btn-primary">
        Back to Search
      </button>
    </div>

    <!-- Booking Form -->
    <div *ngIf="!flag">
      <h1>Book Flight</h1>

      <!-- Flight Info -->
      <div *ngIf="flight" class="flight-info">
        <h3>Flight Details</h3>
        <p><strong>{{ flight.airlineName }}</strong> ({{ flight.flightNumber }})</p>
        <p>{{ flight.fromPlace }} → {{ flight.toPlace }}</p>
        <p>Available Seats: <strong>{{ flight.availableSeats }}</strong> / {{ flight.totalSeats }}</p>
      </div>

      <!-- Step 1: Select Number of Passengers -->
      <div *ngIf="currentStep === 1" class="step-container">
        <h3>Step 1: How many passengers?</h3>
        
        <div class="passenger-selector">
          <button 
            type="button" 
            (click)="setNumberOfPassengers(numberOfPassengers - 1)"
            [disabled]="numberOfPassengers <= 1"
            class="btn-counter">
            −
          </button>
          
          <span class="passenger-count">{{ numberOfPassengers }}</span>
          
          <button 
            type="button" 
            (click)="setNumberOfPassengers(numberOfPassengers + 1)"
            [disabled]="flight && numberOfPassengers >= flight.availableSeats"
            class="btn-counter">
            +
          </button>
        </div>

        <p class="helper-text">Select the number of passengers (1-{{ flight?.availableSeats || 0 }})</p>

        <div *ngIf="error" class="error-message">
          {{ error }}
        </div>

        <div class="buttons">
          <button type="button" (click)="cancel()" class="btn-secondary">
            Cancel
          </button>
          <button 
            type="button" 
            (click)="goToSeatSelection()"
            class="btn-primary">
            Next: Select Seats
          </button>
        </div>
      </div>

      <!-- Step 3: Fill Passenger Details -->
      <div *ngIf="currentStep === 3">
        <div class="step-header">
          <h3>Step 3: Passenger Details</h3>
          <button type="button" (click)="backToSeatSelection()" class="btn-link">
            ← Change Seats
          </button>
        </div>

        <!-- Selected Seats Display -->
        <div class="selected-seats-display">
          <p><strong>Selected Seats:</strong> {{ selectedSeats.join(', ') }}</p>
        </div>

        <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()">
          
          <!-- Contact Info -->
          <h4>Contact Information</h4>
          <div class="form-row">
            <input 
              type="text" 
              formControlName="name" 
              placeholder="Your Name"
              [class.invalid]="bookingForm.get('name')?.invalid && bookingForm.get('name')?.touched"
            />
            <input 
              type="email" 
              formControlName="email" 
              placeholder="Email"
              [class.invalid]="bookingForm.get('email')?.invalid && bookingForm.get('email')?.touched"
            />
          </div>

          <!-- Passenger Details -->
          <div formArrayName="passengers">
            <h4>Passenger Information</h4>
            
            <div *ngFor="let passenger of passengers.controls; let i = index"
                 [formGroupName]="i"
                 class="passenger-section">

              <h5>
                Passenger {{ i + 1 }} - Seat {{ passenger.value.seatNumber }}
              </h5>

              <div class="form-row">
                <input 
                  type="text"
                  formControlName="passengerName"
                  placeholder="Passenger Name"
                  [class.invalid]="passenger.get('passengerName')?.invalid && passenger.get('passengerName')?.touched"
                />
                
                <input 
                  type="number"
                  formControlName="age"
                  placeholder="Age"
                  min="1"
                  max="120"
                  [class.invalid]="passenger.get('age')?.invalid && passenger.get('age')?.touched"
                />
              </div>

              <div class="form-row">
                <select 
                  formControlName="gender"
                  [class.invalid]="passenger.get('gender')?.invalid && passenger.get('gender')?.touched"
                >
                  <option value="" disabled selected>Gender</option>
                  <option value="MALE">Male</option>
                  <option value="FEMALE">Female</option>
                </select>
                
                <select 
                  formControlName="mealPreference"
                  [class.invalid]="passenger.get('mealPreference')?.invalid && passenger.get('mealPreference')?.touched"
                >
                  <option value="" disabled selected>Meal Preference</option>
                  <option value="VEG">Vegetarian</option>
                  <option value="NON_VEG">Non-Vegetarian</option>
                </select>
              </div>

            </div>
          </div>

          <div *ngIf="error" class="error-message">
            {{ error }}
          </div>
          
          <div class="buttons">
            <button 
              type="button" 
              (click)="backToPassengerCount()"
              class="btn-secondary">
              ← Start Over
            </button>
            <button 
              type="submit"
              [disabled]="bookingForm.invalid || loading"
              class="btn-primary">
              {{ loading ? 'Booking...' : 'Confirm Booking' }}
            </button>
          </div>
        </form>
      </div>

    </div>

  </div>

  <!-- Seat Map Modal (Step 2) -->
  <div *ngIf="showSeatMap && currentStep === 2" class="seat-map-overlay">
    <div class="seat-map-modal" (click)="$event.stopPropagation()">
      
      <!-- Modal Header -->
      <div class="seat-map-header">
        <h2>Step 2: Select {{ numberOfPassengers }} Seat(s)</h2>
        <p class="seats-selected-count">
          {{ selectedSeats.length }} / {{ numberOfPassengers }} seats selected
        </p>
      </div>

      <!-- Legend -->
      <div class="seat-legend">
        <div class="legend-item">
          <div class="seat-preview seat-available"></div>
          <span>Available</span>
        </div>
        <div class="legend-item">
          <div class="seat-preview seat-booked"></div>
          <span>Booked</span>
        </div>
        <div class="legend-item">
          <div class="seat-preview seat-selected"></div>
          <span>Your Selection</span>
        </div>
      </div>

      <!-- Error Message -->
      <div *ngIf="error" class="error-message-modal">
        {{ error }}
      </div>

      <!-- Seat Map -->
      <div class="seat-map-container">
        <div class="cockpit">← COCKPIT →</div>
        
        <div class="seats-grid">
          <div *ngFor="let row of seats; let rowIndex = index" class="seat-row">
            <div class="row-label">{{ rowIndex + 1 }}</div>
            <div *ngFor="let seat of row; let i = index" class="seat-wrapper">
              <button
                type="button"
                class="seat"
                [class.seat-available]="!seat.isBooked && !seat.isSelected"
                [class.seat-booked]="seat.isBooked"
                [class.seat-selected]="seat.isSelected"
                [disabled]="seat.isBooked"
                [title]="seat.isBooked ? 'Already booked' : 'Available'"
                (click)="selectSeat(seat)">
                {{ seat.number }}
              </button>
              <div *ngIf="i === 2" class="aisle">
                <div class="aisle-line"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="seat-map-footer">
          <p>Click seats to select/deselect. Select {{ numberOfPassengers }} seat(s) to continue.</p>
          
          <div class="modal-buttons">
            <button 
              type="button" 
              (click)="closeSeatMap()"
              class="btn-secondary">
              ← Back
            </button>
            <button 
              type="button"
              (click)="goToPassengerDetails()"
              [disabled]="!canProceedToPassengerDetails()"
              class="btn-primary">
              Next: Fill Details →
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
